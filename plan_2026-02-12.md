# Plan: microgpt-rs-dual (2026-02-12)

## Objective

Build a Rust microGPT project with:

1. A readable scalar implementation for learning and correctness.
2. A tensor-backed implementation for speed.
3. A small ablation harness for design choices people care about.

## Success Criteria

- The project trains and samples in both `scalar` and `tensor` modes.
- A single `ablate` command compares all four combinations:
  - tied `lm_head` + no input `rmsnorm`
  - tied `lm_head` + input `rmsnorm`
  - untied `lm_head` + no input `rmsnorm`
  - untied `lm_head` + input `rmsnorm`
- Output includes:
  - final loss
  - mean loss over last N steps
  - tokens/sec or steps/sec
- Unit tests cover core math/autograd primitives.

## Phases

## Phase 1: Baseline scalar path

- Implement tokenizer and dataset loader (`input.txt` compatible).
- Implement scalar `Value` autograd type and backward pass.
- Implement microGPT forward pass in scalar mode.
- Implement Adam optimizer and training loop.
- Add deterministic seed handling.
- Add regression tests for:
  - simple gradient checks
  - loss decreases on tiny dataset

## Phase 2: Tensor path

- Select tensor backend (initial candidate: Candle).
- Implement equivalent model components.
- Match scalar defaults and initialization strategy.
- Add parity checks (shape + rough loss trend).

## Phase 3: Ablation harness

- Add config toggles for:
  - `tie_lm_head: bool`
  - `input_rmsnorm: bool`
- Implement `ablate` command running four configs with shared seed and dataset split.
- Emit concise comparison table (loss and speed).

## Phase 4: Docs and polish

- Document command usage and expected runtime.
- Add troubleshooting notes (CPU-only, backend issues).
- Add reproducibility section with seed and environment details.

## Risks

- Exact scalar/tensor parity may differ due to backend numerics.
- Performance claims can be misleading without fixed hardware context.
- Over-optimizing early can hurt readability.

## Guardrails

- Keep scalar path simple and readable.
- Keep tests strict; do not relax assertions to make CI pass.
- Prefer small, reviewable commits.
